<section class="content-header">
    <h1>
        <span>班组工资单</span>
        <small>新增</small>
    </h1>
    <ol class="breadcrumb">
        <li><a href="${basePath}"><i class="fa fa-dashboard"></i> 首页</a></li>
        <li><a href="#">项目管理</a></li>
        <li class="active">新增班组工资单</li>
    </ol>
</section>

    

<section class="content">
    <div class="row">
        <div class="col-xs-12">
            <div class="box box-info">
                <div class="box-header with-border">
                    <span>
                        <i class="fa fa-files-o">本次可申报工资总额:<font color="red" size="6"><span id="aTotal"></span>元</font></i>
                    </span>
                </div>
                <div id="stepbar" class="add stepbar">
                    <div>
                        <div class="step">
                            <span class="tip">1</span>
                        </div>
                        <div class="stepinfo">添加工资单条目</div>
                    </div>
                    <div>
                        <div class="step step">
                            <span class="tip">2</span>
                        </div>
                        <div class="stepinfo">编辑工资单明细</div>
                    </div>
                    <div>
                        <div class="step stepundone">
                            <span class="tip">3</span>
                        </div>
                        <div class="stepinfo undoneinfo">完成</div>
                    </div>
                </div>
                
                <form id="salary-detail-form" name="salary-detail-form" class="form-horizontal">
                	<input type="hidden" name="salaryID" id="salaryID">
                    <input type="hidden" name="name" id="name">
                    <input type="hidden" name="total" id="total">
                    <div class="box-body">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="col-sm-3 control-label">名称<span style="color:red">*</span></label>
                                <div class="col-sm-8">
                                    <select id="userID" class="form-control select2" name="userID">
				                        <option selected="selected" value="">选择一个成员</option>
				                    </select>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-sm-3 control-label">身份证号<span style="color:red">*</span></label>
                                <div class="col-sm-8">
                                    <input type="text" class="form-control" id="identificationNumber" name="identificationNumber" readonly="readonly">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-sm-3 control-label">出勤天数<span style="color:red">*</span></label>
                                <div class="col-sm-7">
                                    <input type="text" class="form-control" id="attendance" name="attendance" onkeyup="value=value.replace(/[^\d.]/g,'')" placeholder="出勤天数">
                                </div>
                                <span style="line-height: 35px;"><a href="javascript:void(0)" onclick='salaryDetailCtrl.attendanceDetail();return false;'>查看考勤</a></span>
                            </div>
                            <div class="form-group">
                                <label class="col-sm-3 control-label">借款扣除（元）<span style="color:red">*</span></label>
                                <div class="col-sm-8">
                                    <input type="text" class="form-control" onkeyup="value=value.replace(/[^\d.]/g,'')" value="0" id="loan" name="loan" placeholder="借款扣除">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-sm-3 control-label">社保扣除（元）<span style="color:red">*</span></label>
                                <div class="col-sm-8">
                                    <input type="text" class="form-control" onkeyup="value=value.replace(/[^\d.]/g,'')" value="0" id="social" name="social" placeholder="社保扣除">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-sm-3 control-label">实发工资（元）<span style="color:red">*</span></label>
                                <div class="col-sm-8">
                                    <input type="text" class="form-control" onkeyup="value=value.replace(/[^\d.]/g,'')" value="0" id="actual" name="actual" placeholder="实发工资">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-sm-3 control-label">备注</label>
                                <div class="col-sm-8">
                                    <input type="text" class="form-control" id="remark" name="remark">
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="col-sm-3 control-label">工种<span style="color:red">*</span></label>
                                <div class="col-sm-8">
                                    <input type="text" class="form-control" id="workType" name="workType" readonly="readonly">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-sm-3 control-label">基本工资<span style="color:red">*</span></label>
                                <div class="col-sm-8">
                                    <input type="text" class="form-control" id="basicSalary" name="basicSalary" readonly="readonly">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-sm-3 control-label">应付工资<span style="color:red">*</span></label>
                                <div class="col-sm-8">
                                    <input type="text" class="form-control" id="payable" name="payable" value="0" onkeyup="value=value.replace(/[^\d.]/g,'')" placeholder="应付工资">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-sm-3 control-label">医保扣除（元）<span style="color:red">*</span></label>
                                <div class="col-sm-8">
                                    <input type="text" class="form-control" onkeyup="value=value.replace(/[^\d.]/g,'')" value="0" id="medical"  name="medical" placeholder="医保扣除">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-sm-3 control-label">个税扣除（元）<span style="color:red">*</span></label>
                                <div class="col-sm-8">
                                    <input type="text" class="form-control" onkeyup="value=value.replace(/[^\d.]/g,'')" value="0" id="tax" name="tax" placeholder="个税扣除" >
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-sm-3 control-label">联系电话<span style="color:red">*</span></label>
                                <div class="col-sm-8">
                                    <input type="text" class="form-control" id="mobile" name="mobile" placeholder="联系电话" readonly="readonly">
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="box-footer text-center">
                        <button type=submit class="btn btn-success ml10" data-btn-type="save">添加明细</button>
                        <button type="button" class="btn btn-default" data-btn-type="prev">返回列表</button>
                    </div>
                </form>
            </div>
            <div class="box box-success">
                <div class="box-header with-border">
                    <span>
                        <i class="fa fa-files-o">工资单明细</i>
                    </span>
                </div>
                <div class="dataTables_filter" id="searchDiv" style="display:none;">
                   <input type="search" name="salaryID" id="salaryID" class="form-control" operator="eq" style="display:none;">
                </div>
                <div class="box-body">
                    <!-- 内容 -->
                    <table id="salary_detail_table" class="table table-bordered table-striped table-hover">\
                        <tfoot>
                            <tr>
                                <th colspan="12" style="text-align:right">合计:</th>
                                <th class="text-left">0</th>
                                <th class="text-left"></th>
                                <th class="text-left"></th>
                                <th class="text-left"></th>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>
    </div>
</section>
<script>
    var form;
    var id = "${id}", total = "${total}";
    $('#salaryID').val(id);
    $('#salaryID',$('#searchDiv')).val(id);
    $('#total').val(total);
    $('#aTotal').html(total);
    var userOptions = '${userOptions?default(0)}',options=0;
    if(userOptions != 0){
        options = JSON.parse(userOptions);
    }
    var salaryDetailTable, winId = "salaryDetailWin";
    var salaryDetailCtrl = {
        initButtonEvent: function () {
            $("button[data-btn-type='prev']").click(function () {
                loadPage(basePath+"/project/team/salary/list");
            });
        },
        deleteDetail: function (rowId) {
            modals.confirm("是否要删除该行数据？",function(){
                ajaxPost(basePath+"/project/team/salary/deletedetail/"+rowId,null,function(data){
                    if(data.success){
                    	salaryDetailTable.reloadRowData();
                    }else{
                        modals.error("删除失败！");
                    }
                });
            })
        },
        attendanceDetail: function (){
            var name = "1";
            if ($("#userID").prop('selectedIndex') > 0) {
                name = $("#userID").find("option:selected").text();
            }
            modals.openWin({
                winId:winId,
                title:'考勤详情',
                width:'1000px',
                url:basePath+"/attendance/detail/" + name
               });
        }
    }
    $(function () {
    	salaryDetailTable = new CommonTable("salary_detail_table", "team_salary_detail", "searchDiv", {
            "footerCallback": function ( row, data, start, end, display ) {
                var api = this.api(), data;
                // Remove the formatting to get integer data for summation
                var intVal = function ( i ) {
                    return typeof i === 'string' ?
                        i.replace(/[\$,]/g, '')*1 :
                        typeof i === 'number' ?
                            i : 0;
                };
     
                // Total over this page
                unitTotal = api
                    .column( 12, { page: 'current'} )
                    .data()
                    .reduce( function (a, b) {
                        return accAddition(intVal(a), intVal(b));
                    }, 0 );
                // Update footer
                $( api.column( 12 ).footer() ).html(
                    '￥'+unitTotal
                );
            }
        });
        //初始化表单 
        form = $("#salary-detail-form").form({baseEntity:false});
        //数据校验
        $("#salary-detail-form").bootstrapValidator({
            message: '请输入有效值',
            feedbackIcons: {
                valid: 'glyphicon glyphicon-ok',
                invalid: 'glyphicon glyphicon-remove',
                validating: 'glyphicon glyphicon-refresh'
            },
            submitHandler: function () {
                var action = $(this).attr('$submitButton').attr('data-btn-type');
                var formData = form.getFormSimpleData();
                ajaxPost(basePath + '/project/team/salary/savedetail', formData, function (data) {
                    if (data.success) {
                    	salaryDetailTable.reloadData();
                    } else {
                        modals.error(data.message);
                    }
                });
            },
            fields: {
                "attendance": {
                    validators: {
                        notEmpty: {message: '出勤天数不能为空'}
                    }
                },
                "payable": {
                    validators: {
                        notEmpty: {message: '应付工资不能为空'}
                    }
                },
                "loan": {
                    validators: {
                        notEmpty: {message: '借款扣除不能为空'}
                    }
                },
                "medical": {
                    validators: {
                        notEmpty: {message: '医保扣除不能为空'}
                    }
                },
                "social": {
                    validators: {
                        notEmpty: {message: '社保扣除不能为空'}
                    }
                },
                "tax": {
                    validators: {
                        notEmpty: {message: '个税扣除不能为空'}
                    }
                }
            }
        });
        //初始化控件
        form.initComponent();
        salaryDetailCtrl.initButtonEvent();
        
        if(options != 0){
            for (var i = 0, len = options.length; i < len; i++) {
                var option = options[i];
                $('#userID').append("<option value=\"" + option.value + "\">" + option.data + "</option>");
            }
            $("#userID").select2();
            $("#userID").bind("change", function () {
                var value = $(this).val();
                if (value === "") {
                    return false;
                }
                
                ajaxPost(basePath+"/project/team/salary/getinfo",{userID:value},function(data){
                	form.initFormData(data);
                });
            });
        }
        
    });
    
    function fnRenderSalaryDetail(value, type, rowObj){
        var oper = "&nbsp;&nbsp;&nbsp;<a href='javascript:void(0)' onclick='salaryDetailCtrl.deleteDetail(\"" + value + "\")'>删除</a>";
        return oper;
    }

</script>
