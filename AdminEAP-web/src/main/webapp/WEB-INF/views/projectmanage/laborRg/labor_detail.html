<link rel="stylesheet" href="${basePath}/resources/common/libs/fileinput/css/fileinput.min.css">
<style>

#projectaddstep2 .krajee-default.file-preview-frame .kv-file-content {
    height: auto;
}

#projectaddstep2 .krajee-default .file-footer-caption {
    width: 100px;
}

</style>

<script src="${basePath}/resources/common/libs/fileinput/js/fileinput.js"></script>
<script src="${basePath}/resources/common/libs/fileinput/js/locales/zh.js"></script>
<!--BaseFile组件-->
<script src="${basePath}/resources/common/js/base-file.js"></script>
<script src="${basePath}/resources/common/js/calculate.js"></script>
<section class="content">
    <div class="row">
        <div class="col-xs-12">
            <div class="box box-info">
                <div class="box-header with-border">
                    <span>
                        <i class="fa fa-files-o">包清工合同明细</i>
                    </span>
                </div>
                <form id="labor-detail-form" name="labor-detail-form" class="form-horizontal">
                    <div class="box-body">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="col-sm-3 control-label">所属项目<span style="color:red">*</span></label>
                                <div class="col-sm-8">
                                    <input type="text" class="form-control" id="projectName" name="projectName" >
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-sm-3 control-label">承包人<span style="color:red">*</span></label>
                                <div class="col-sm-8">
                                    <input type="text" class="form-control" id="contractor" name="contractor" placeholder="承包人" >
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-sm-3 control-label">施工负责人<span style="color:red">*</span></label>
                                <div class="col-sm-8">
                                    <input type="text" class="form-control" id="constructionManager" name="constructionManager" >
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-sm-3 control-label">机械费（单位：元）<span style="color:red">*</span></label>
                                <div class="col-sm-8">
                                    <input type="text" class="form-control calculate" id="mechPrice" name="mechPrice" placeholder="机械费" >
                                </div>
                            </div>
                            <!-- <div class="form-group">
                                <label class="col-sm-3 control-label">人工费（单位：元）<span style="color:red">*</span></label>
                                <div class="col-sm-8">
                                    <input type="text" class="form-control calculate" id="labourPrice" name="labourPrice" placeholder="人工费" >
                                </div>
                            </div> -->
                            <div class="form-group">
                                <label class="col-sm-3 control-label">甲方</label>
                                <div class="col-sm-8">
                                    <input type="text" class="form-control" id="gander" name="gander" >
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-sm-3 control-label">承包方式</label>
                                <div class="col-sm-8">
                                    <input type="text" class="form-control" id="contractMode" name="contractMode" >
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-sm-3 control-label">质保金约定（单位：元）</label>
                                <div class="col-sm-8">
                                    <input type="text" class="form-control" id="guaranteeMoney" name="guaranteeMoney" >
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="col-sm-3 control-label">合同名称<span style="color:red">*</span></label>
                                <div class="col-sm-8">
                                    <input type="text" class="form-control" id="contractName" name="contractName" >
                                </div>
                            </div>
                            <!-- <div class="form-group">
                                <label class="col-sm-3 control-label">施工班组<span style="color:red">*</span></label>
                                <div class="col-sm-8">
                                    <input type="text" class="form-control" id="constructionTeam" name="constructionTeam" >
                                </div>
                            </div> -->
                            <div class="form-group">
                                <label class="col-sm-3 control-label">合同总价<span style="color:red">*</span></label>
                                <div class="col-sm-8">
                                    <input type="text" class="form-control" id="contractPrice" name="contractPrice" >
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-sm-3 control-label">材料费（单位：元）<span style="color:red">*</span></label>
                                <div class="col-sm-8">
                                    <input type="text" class="form-control calculate" id="matPrice" name="matPrice" placeholder="材料费" >
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-sm-3 control-label">包工包料（单位：元）<span style="color:red">*</span></label>
                                <div class="col-sm-8">
                                    <input type="text" class="form-control calculate" id="packagePrice" name="packagePrice" placeholder="包工包料" >
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-sm-3 control-label">乙方</label>
                                <div class="col-sm-8">
                                    <input type="text" class="form-control" id="goose" name="goose" >
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-sm-3 control-label">付款方式</label>
                                <div class="col-sm-8">
                                    <input type="text" class="form-control" id="paymentMode" name="paymentMode" >
                                </div>
                            </div>
                            
                        </div>
                        <div class="col-md-12">
                        	<div class="form-group">
                                <label class="col-sm-3 control-label">人工费单价（描述）<span style="color:red"></span></label>
                                <div class="col-sm-6">
                                    <textarea class="form-control" id="labourSin" name="labourSin" rows="3" cols="100" ></textarea>
                                </div>
                            </div>
                        	<div class="form-group">
                                <label class="col-sm-3 control-label">内容</label>
                                <div class="col-sm-6">
                                    <textarea class="form-control" id="serviceContent" name="serviceContent" rows="3" cols="100" ></textarea>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-sm-3 control-label">质量目标</label>
                                <div class="col-sm-6">
                                    <textarea class="form-control" id="qualityTarget" name="qualityTarget" rows="3" cols="100" ></textarea>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-sm-3 control-label">纠纷处理</label>
                                <div class="col-sm-6">
                                    <textarea class="form-control" id="issue" name="issue" rows="3" cols="100" ></textarea>
                                </div>
                            </div>
                        </div>
                         <div class="form-group">
                                <label class="col-sm-3 control-label">包清工合同<span style="color:red">*</span></label>
                                <div class="col-sm-6">
                                    <input type="hidden" name="contractFile" id="contractFile">
                                    <div class="form-group" id="wjscid">
                                        <div class="btn btn-default btn-file" id="contractfileupload">
                                            <i class="fa fa-paperclip"></i> 上传包清工合同(最大. 100MB)
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <input type="file" name="contractfileattachment" id="contractfileattachment">
                                    </div> 
                                </div>
                            </div>
                            <div class="box-footer text-center">
		                        <button type="submit" class="btn btn-success ml10" data-btn-type="save" id="saves">保存</button>
		                    </div>
                    </div>
                   
                </form>
                <!-- /.box-footer -->
		        <div  class="box-body">
		    	<table id="sps" class="table table-bordered table-striped table-hover">
		    		<tr>
		    			<th>部门</th>
		    			<th>评审风险点</th>
		    			<th>评审意见</th>
		    			<th>评审人</th>
		    		</tr>
		         </table>
		   		</div>
            </div>
        </div>
    </div>
</section>
<script>
    var form,laborSubTable;
    var id = "${id}";
    var ck = "${ck?default(0)}"
   	if(ck==1){
   		$("#wjscid").css("display","none")
   		$("#contractfileattachment").css("display","none")
   		$("#saves").css("display","none")
   	}
    $('#laborID',$('#searchDiv')).val(id);
    $(function () {
        //初始化表单 
        form = $("#labor-detail-form").form({baseEntity:false});
      //数据校验
        $("#labor-detail-form").bootstrapValidator({
            message: '请输入有效值',
            feedbackIcons: {
                valid: 'glyphicon glyphicon-ok',
                invalid: 'glyphicon glyphicon-remove',
                validating: 'glyphicon glyphicon-refresh'
            },
            submitHandler: function () {
                var action = $(this).attr('$submitButton').attr('data-btn-type');
                var formData = form.getFormSimpleData();
                ajaxPost(basePath + '/labor/save?htlx=10&id='+id, formData, function (data) {
                    if (data.success) {
                    	modals.info("修改成功");
                    } else {
                        modals.error("保存失败！请检查班组是否重复");
                    }
                });
            },
            fields: {
                "projectID": {
                    validators: {
                        notEmpty: {message: '项目不能为空'}
                    }
                },
                "contractName": {
                    validators: {
                        notEmpty: {message: '合同名称不能为空'}
                    }
                },
                "contractor": {
                    validators: {
                        notEmpty: {message: '承包人不能为空'}
                    }
                },
                "constructionManagerID": {
                    validators: {
                        notEmpty: {message: '施工负责人不能为空'}
                    }
                },
                "labourSin": {
                    validators: {
                        notEmpty: {message: '人工费单价不能为空'}
                    }
                },
                "contractPrice": {
                    validators: {
                        notEmpty: {message: '合计不能为空'}
                    }
                }
            }
        });
        //初始化控件
        form.initComponent();
        
        //编辑回填
        if(id!="0"){
            ajaxPost(basePath+"/labor/getStep2",{id:id},function(data){
                form.initFormData(data);
            })
            ajaxPost(basePath+"/labor/loadSpyj",{id:id},function(data){
	         	var list = data.data;
	         	var trs ="";
	         	for(var i=0;i<list.length;i++){
					trs+="<tr>";
					trs+="<td>"+deptChange(list[i].taskNode)+"</td>";
					trs+="<td>"+list[i].risk+"</td>";
					trs+="<td>"+list[i].suggestion+"</td>";
					trs+="<td>"+list[i].operator+"</td>";
					trs+="</tr>";
	             }
	             $("#sps").append(trs);
	         })
        }
        
    });
    function deptChange(value){
    	if(value=="fawu"){
    		return "法务部门";
    	}else if(value=="jinying"){
    		return "经营部门";
    	}else if(value=="gongchen"){
    		return "工程部门";
    	}else if(value=="bangong"){
    		return "办公部门";
    	}else if(value=="caiwu"){
    		return "财务部门";
    	}else if(value=="jinyingF"){
    		return "项目经理总结";
    	}else if(value=="boss"){
    		return "总经理";
    	}else{
    		return "";
    	}
    	
    }
    var fileinputDefaults = {
          maxFileSize: 102400,
          maxFileCount:10,
          previewSettings: {
              image: {width: "160px", height: "60px"},
              text: {width: "213px", height: "160px"},
              object: {width: "160px", height: "auto"},
              pdf: {width: "160px", height: "160px"},
              other: {width: "160px", height: "160px"}
          },
          previewZoomSettings: {
              image: {width: "auto", height: "auto", 'max-width': "100%", 'max-height': "100%"},
              text: {width: "100%", height: "100%", 'min-height': "480px"},
              object: {width: "auto", height: "100%", 'min-height': "480px"},
              pdf: {width: "100%", height: "100%", 'min-height': "480px"},
              other: {width: "auto", height: "100%", 'min-height': "480px"}
          },
          uploadUrl: basePath + "/labor/uploadMultipleFile",
          deleteUrl: basePath + "/project/deletefile",
          allowedPreviewTypes : ['image', 'object']
    }
    var defaults = {
          title: "请上传附件",
          getFileResultUrl: basePath+"/project/getFiles",
          downloadFileUrl: basePath+"/project/download/",
          fileinput: fileinputDefaults,
          showType:'detail',
          window:true,
          callback:function(fileIds,oldfileIds){
              this.showFiles({
                  fileIds:fileIds,
                  type:'preview'
              });
          }
    }
    
    $("#contractfileupload").file($.extend({}, defaults, {
        title:"请上传劳务合同",
        fileinput:$.extend({}, fileinputDefaults, {
            uploadExtraData: {"id":id,"fileField":"contractFile"}
        }),
        showContainer:'#contractfileattachment',
        fileIdContainer:"[name='contractFile']",
        extraPreviewConfig:{
            "fileField":"contractFile"
        }
    }));

</script>
