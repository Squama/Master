<section class="content-header">
    <h1 id="titleH">
        
    </h1>
</section>

<section class="content">
    <div class="row">
        <div class="col-xs-12">
            <div class="box">
                <!-- /.box-header -->
                <div class="dataTables_filter" id="searchDiv" >
                    <!-- <select id="projectID" class="form-control select2" name="pv.project_id" style="width:200px;" operator="eq">
                    	<option selected="selected" value="">选择一个项目</option>
                    </select> -->
                    <input id="volumeId" name="volumeId" class="form-control" type="search" style="display:none" likeOption="true" operator="like"/> 
                    <input id="type" name="payType" class="form-control" type="search" style="display:none" likeOption="true" operator="like"/> 
                    <div class="btn-group">
                        <button type="button" class="btn btn-primary" data-btn-type="search">查询</button>
                        <button type="button" class="btn btn-default" data-btn-type="reset">重置</button>
                    </div>
                    <div class="btn-group">
                        <button type="button" class="btn btn-default" data-btn-type="add">新增</button>
                        <button type="button" class="btn btn-default" data-btn-type="edit" >编辑</button>
                        <button type="button" class="btn btn-default" data-btn-type="look" >查看</button>
                        <button type="button" class="btn btn-default" data-btn-type="print" >打印</button>
                        <button type="button" class="btn btn-default" data-btn-type="del" >删除</button>
                        <button type="button" class="btn btn-primary" data-btn-type="out" >返回</button>
                    </div>
                </div>
                <div class="box-body">
                    <table id="volume_table" class="table table-bordered table-striped table-hover">
                    </table>
                </div>
            </div>
            <div class="box box-success">
                <div class="box-header with-border">
                    <span>
                        <i class="fa fa-files-o">工资单明细</i>
                    </span>
                </div>
                <div class="dataTables_filter" id="searchDivDetail" style="display:none;">
                   <input type="search" name="salaryID" id="salaryID" class="form-control" operator="eq" style="display:none;">
                </div>
                <div class="box-body">
                    <!-- 内容 -->
                    <table id="salary_detail_table" class="table table-bordered table-striped table-hover">
                    </table>
                </div>
            </div>
        </div>
    </div>
</section>

<script>
    var form = $("#searchDiv").form({baseEntity: false}), initData={};
    var volumeTable,salaryDetailTable, winId = "volumeWin";
    var gclid = '${gclid?default(0)}'
    var type = '${type?default(0)}'
    var zdr = '${zdr}'
    var gz = '${gz?default(0)}'
    var zje="${zje?default(0)}";
    var kzf = "${kzf?default(0)}";
    if(gz!=0){
    	gz=JSON.parse(gz);
    	$('#salaryID',$('#searchDivDetail')).val(gz.id);
    }else{
    	$('#salaryID',$('#searchDivDetail')).val("0");
    }
    var volumeManageObject = {
        		auid: function (rowID,payType) {
        			modals.confirm("是否要提交审批？",function(){
                        ajaxPost(basePath + '/volumepay/start', {id:rowID}, function (data) {
                            if (data.success) {
                            	volumeTable.reloadData();
                                modals.correct("流程已启动，请及时处理");
                            } else {
                                modals.error(data.message);
                            }
                        });
                    });
           		 },
           		auidNo:function (rowID,payType){
           			modals.info("驳回原因： "+rowID);
           		}
    }
    
    $(function (){
    	if(gclid!=0){
    		$("#volumeId").val(gclid);
    	}
    	if(type!=0){
    		$("#type").val(type);
    	}
    	if(gz!=0){
    		$("#volumeId").val(gz.id);
    		$("#titleH").html("人工费支付列表---"+"应付金额："+zje+"元,剩余可支付金额:"+kzf+"元");
    	}else{
    		$("#titleH").html("人工费支付列表-----未查到工资单数据");
    	}
    	
    	volumeTable = new CommonTable("volume_table", "volumePay_list", "searchDiv", {
    		"ordering" : false,
            "lengthChange": false,
            "displayLength": 20,
            "scrollY": "200px",
            "scrollCollapse": true});
    	salaryDetailTable = new CommonTable("salary_detail_table", "team_salary_detail_overview", "searchDivDetail", {
    		"ordering" : false,
            "lengthChange": false,
            "displayLength": 20,
            "scrollY": "200px",
            "scrollCollapse": true});
        
        //绑定按钮事件
        $("button[data-btn-type]").click(function () {
            var action = $(this).data("btn-type");
            var rowId = volumeTable.getSelectedRowId();
            if(gz==0&&action!='out'){
            	modals.info('请生成工资单后再进行支付操作');
            	return ;
            }
            switch (action) {
            case 'add':
            	var url =basePath+"/volumepay/addPayInfoRg?gclid="+gclid+"&&gzid="+gz.id;
            	if(type==10){
            		zflx="人工";
            	}else if(type==20){
            		zflx="机械";
            	}else if(type==30){
            		zflx="材料";
            	}
            	modals.openWin({
                    winId:winId,
                    title:zflx+'支付',
                    width:'900px',
                    url:url,
                    hideFunc:function(){
                   	 volumeTable.reloadData();
                    }
                   });                       
             break;
         case 'edit':
             if(!rowId){
                 modals.info('请选择要编辑的支付信息');
                 return false;
             }
             var shzt = volumeTable.getSelectedRowData().status;
             if(shzt!='新建'){
            	 modals.info('该状态不可进行编辑');
                 return false;
             }
             
             modals.openWin({
                 winId:winId,
                 title:'编辑支付信息',
                 width:'800px',
                 url:basePath+"/volumepay/addPayInfoRg?zfid="+rowId+"&&gzid="+gz.id+"&&gclid="+gclid+"&&lx=edit",
                 hideFunc:function(){
                	 volumeTable.reloadData();
                 }
                });
            break;
         case 'look':
             if(!rowId){
                 modals.info('请选择要查看的支付信息');
                 return false;
             }
             modals.openWin({
                 winId:winId,
                 title:'支付信息详情',
                 width:'800px',
                 url:basePath+"/volumepay/addPayInfoRg?zfid="+rowId+"&&gzid="+gz.id+"&&gclid="+gclid+"&&lx=look",
                 hideFunc:function(){
                	 volumeTable.reloadData();
                 }
                });
            break;
         case 'del':
             if(!rowId){
                 modals.info('请选择要删除的支付信息');
                 return false;
             }
             var shzt = volumeTable.getSelectedRowData().status;
             if(shzt!='新建'&&shzt!='审核不通过'){
            	 modals.info('该状态不可删除');
                 return false;
             }
             ajaxPost(basePath + '/volumepay/delPayInfo', {id:rowId}, function (data) {
                 if (data.success) {
                 	modals.info('删除成功');
                 	volumeTable.reloadData();
                 }
             });
            break;
         case 'out':
         	loadPage(basePath+"/volumepay/list");
         	break;
         case 'print':
        	 if(!rowId){
                 modals.info('请选择要打印的支付信息');
                 return false;
             }
             var shzt = volumeTable.getSelectedRowData().status;
             if(shzt!='审核通过'){
            	 modals.info('该状态不可打印');
                 return false;
             }
             var url = basePath+"/ureport/preview?_u=file:volumePay.ureport.xml&_t=1,5&id="+rowId+"&zdr="+zdr;
        	 	window.open(url);
        	 break;
         
         }
            
        });
        
    });
    function fnRenderGl(value, type, rowObj){
    	var oper ="";
    	if(rowObj.status=='新建'){
    		oper +="&nbsp;&nbsp;&nbsp;<a href='javascript:void(0)' onclick='volumeManageObject.auid(\"" + rowObj.id + "\")'>提交审核</a>";
    	}
    	if(rowObj.status=='审核不通过'){
    		oper +="&nbsp;&nbsp;&nbsp;<a href='javascript:void(0)' onclick='volumeManageObject.auidNo(\"" + rowObj.rebutReason.replace(/[\r\n]/g,'') + "\")'>查看驳回原因</a>";
    	}
        return oper;
    }
    
</script>